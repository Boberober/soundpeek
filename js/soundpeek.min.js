window.Soundpeek=function(t){function e(t){this.options=i.extend(this.defaults,t),this.docElem=this.options.elem,this.rootUrl="https://api.spotify.com/v1",this.templateCache={},this.elems=[],this.options.init&&this.init()}var i;return e.prototype={defaults:{init:!0,elem:t.document.documentElement,fillEmptyWithTrack:!0,elementID:"spotify-player",targetSelector:".soundpeek",prependElement:"",appendElement:"",offsetTop:20,playSound:!0,delay:0,onPlay:function(){},onPause:function(){},onError:function(){},fadeInVolume:!0,restartPreviewOnPause:!0,defaultLoadingText:"Loading",debug:!1,progressBar:!1,template:'<div class="cover"><img src="{{ track.album.images[1].url }}" alt=""></div><div class="content-container"><div class="content"><div class="track">{{ track.name }}</div><div class="artists">{{ track.artistsString }}</div></div><div class="progress-bar"></div></div>'},init:function(){var t=this;t.timeout={},t.updateTime={};var e=document.createElement("div");e.setAttribute("id",this.options.elementID),e.classList.add(this.options.elementID),this.playerEl=e,document.body.appendChild(this.playerEl),document.addEventListener("mousemove",t.movePopup.bind(t)),this.elems=Array.prototype.slice.call(document.querySelectorAll(t.options.targetSelector)),this.elems.forEach(function(e){t.initializeElement(e)})},get:function(t,e){var i;i=new XMLHttpRequest,i.onreadystatechange=function(){4==i.readyState&&e(JSON.parse(i.responseText))},i.open("GET",t,!0),i.send()},getTrack:function(t,e){var i=this.rootUrl+"/tracks/"+t.replace("spotify:track:","");this.options.debug&&(i="data.json"),this.get(i,function(i){if(i.length>1){for(var n,a=i.length-1;a>=0;a--)if(i[a].id===t){n=i[a];break}i=n||i[0]}return e(i),i})},searchTrack:function(t,e){var i=this.rootUrl+"/search/?q="+t+"&type=track&limit=1";this.get(i,function(t){return t.tracks.items.length>1&&(t.tracks.items=t.tracks.items[0]),e(t.tracks.items[0]),t.tracks.items})},playTrack:function(){var t=this.activeEl,e=this;if(e.options.playSound){e.audio&&e.audio.pause(),e.options.onPlay(e.activeEl),t.audio=t.audio||new Audio(t.track.preview_url),4!==t.audio.readyState?e.playerEl.classList.add("loading"):e.playerEl.classList.remove("loading"),t.audio.onloadeddata=function(){e.playerEl.classList.remove("loading")},e.audio=t.audio;var i=100;if(e.options.progressBar&&e.playerEl.getElementsByClassName(e.options.progressBar)){var n=e.playerEl.getElementsByClassName(e.options.progressBar),a=Array.prototype.slice.call(n);e.updateTime=setInterval(function(){e.audio.currentTime>30&&clearInterval(e.updateTime),a.forEach(function(t){t.style.width=Math.ceil(e.audio.currentTime/30*100)+2+"%"})},i)}e.audio.play(),e.options.fadeInVolume&&e.fadeIn()}},fadeIn:function(){var t=this;t.audio.volume=0;var e=setInterval(function(){t.audio.volume<.8?t.audio.volume+=.005:(t.audio.volume=1,clearInterval(e))},10)},initializeElement:function(t){var e=this;e.setupEl(t,function(t){t.uri=t.getAttribute("data-uri"),void 0===t.track&&e.getTrack(t.getAttribute("data-uri"),function(e){t.track=e}),e.options.prependElement&&!t.hasAttribute("data-no-prepend")&&(t.innerHTML=e.options.prependElement+t.innerHTML),console.log(t.hasAttribute("data-no-append")),e.options.appendElement&&!t.hasAttribute("data-no-append")&&(t.innerHTML=t.innerHTML+e.options.appendElement),t.addEventListener("mouseover",i.debounce(function(t){e.showEl(t,this,e)},e.options.delay)),t.addEventListener("mouseout",e.hideEl.bind(e))})},setupEl:function(t,e){var n=this,a=t.getAttribute("data-uri")||"";i.hasClass(t,n.options.targetSelector)||t.classList.add(n.options.targetSelector.replace(".","")),0===a.length&&t.innerHTML.length>0?n.searchTrack(t.innerHTML,function(i){return console.log(i),void 0===i?void n.options.onError(t):void(i&&(t.setAttribute("data-uri",i.id),e(t)))}):0===t.innerHTML.length&&n.options.fillEmptyWithTrack?(n.options.defaultLoadingText.length>0&&(t.innerHTML=t.getAttribute("data-loading-content")||n.options.defaultLoadingText),n.getTrack(a,function(i){t.innerHTML=i.name,t.track=i,e(t)})):e(t)},showEl:function(t,e,i){var n=i;console.log(e,i),t.stopPropagation(),t.preventDefault(),t.target&&(n.activeEl=e);var e=n.activeEl,a=n.playerEl,o=e.track.artists.map(function(t){return t.name});e.track.artistsString=o.join(", "),n.playerEl.innerHTML=n.renderTemplate(n.options.template,e),e.classList.add("active"),a.classList.add("active"),n.movePopup(t),n.playTrack()},hideEl:function(){var t=this;t.playerEl.classList.remove("active"),t.activeEl.classList.remove("active"),t.options.playSound&&t.audio&&(clearTimeout(t.timeout),clearTimeout(t.updateTime),t.audio.pause(),4===t.audio.readyState&&t.options.restartPreviewOnPause&&(t.audio.currentTime=0),t.options.onPause(t.activeEl))},movePopup:function(t){function e(){return t.pageX+i.playerEl.offsetWidth>document.documentElement.clientWidth}var i=this;i.activeEl&&(i.playerEl.style.left=e()?document.documentElement.clientWidth-i.playerEl.offsetWidth+"px":t.pageX+"px",i.playerEl.style.top=t.clientY+i.playerEl.offsetHeight>document.documentElement.clientHeight?t.pageY-i.playerEl.offsetHeight-i.options.offsetTop+10+"px":t.pageY+i.options.offsetTop+"px")},addEl:function(t){var e=this;t.forEach(function(t){e.initializeElement(t)})},renderTemplate:function n(t,e){var i=this,a=/\W/.test(t)?new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+t.replace(/[\r\t\n]/g," ").split("{{").join("	").replace(/((^|\}\})[^\t]*)'/g,"$1\r").replace(/\t(.*?)\}\}/g,"',$1,'").split("	").join("');").split("}}").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):i.templateCache[t]=i.templateCache[t]||n(document.getElementById(t).innerHTML);return e?a(e):a}},i={debounce:function(t,e,i){var n=this;return function(){var a=this,o=arguments,r=function(){n.timeout=null,i||t.apply(a,o)},s=i&&!n.timeout;clearTimeout(n.timeout),n.timeout=setTimeout(r,e),s&&t.apply(a,o)}},extend:function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t},hasClass:function(t,e){return(" "+t.className+" ").indexOf(" "+e+" ")>-1}},e}(window);